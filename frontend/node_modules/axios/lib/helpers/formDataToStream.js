import***REMOVED***util***REMOVED***from***REMOVED***'util';
import***REMOVED***{Readable}***REMOVED***from***REMOVED***'stream';
import***REMOVED***utils***REMOVED***from***REMOVED***"../utils.js";
import***REMOVED***readBlob***REMOVED***from***REMOVED***"./readBlob.js";
import***REMOVED***platform***REMOVED***from***REMOVED***"../platform/index.js";

const***REMOVED***BOUNDARY_ALPHABET***REMOVED***=***REMOVED***platform.ALPHABET.ALPHA_DIGIT***REMOVED***+***REMOVED***'-_';

const***REMOVED***textEncoder***REMOVED***=***REMOVED***typeof***REMOVED***TextEncoder***REMOVED***===***REMOVED***'function'***REMOVED***?***REMOVED***new***REMOVED***TextEncoder()***REMOVED***:***REMOVED***new***REMOVED***util.TextEncoder();

const***REMOVED***CRLF***REMOVED***=***REMOVED***'\r\n';
const***REMOVED***CRLF_BYTES***REMOVED***=***REMOVED***textEncoder.encode(CRLF);
const***REMOVED***CRLF_BYTES_COUNT***REMOVED***=***REMOVED***2;

class***REMOVED***FormDataPart***REMOVED***{
***REMOVED******REMOVED***constructor(name,***REMOVED***value)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***{escapeName}***REMOVED***=***REMOVED***this.constructor;
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***isStringValue***REMOVED***=***REMOVED***utils.isString(value);

***REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***headers***REMOVED***=***REMOVED***`Content-Disposition:***REMOVED***form-data;***REMOVED***name="${escapeName(name)}"${
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***!isStringValue***REMOVED***&&***REMOVED***value.name***REMOVED***?***REMOVED***`;***REMOVED***filename="${escapeName(value.name)}"`***REMOVED***:***REMOVED***''
***REMOVED******REMOVED******REMOVED******REMOVED***}${CRLF}`;

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(isStringValue)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***value***REMOVED***=***REMOVED***textEncoder.encode(String(value).replace(/\r?\n|\r\n?/g,***REMOVED***CRLF));
***REMOVED******REMOVED******REMOVED******REMOVED***}***REMOVED***else***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***headers***REMOVED***+=***REMOVED***`Content-Type:***REMOVED***${value.type***REMOVED***||***REMOVED***"application/octet-stream"}${CRLF}`
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***this.headers***REMOVED***=***REMOVED***textEncoder.encode(headers***REMOVED***+***REMOVED***CRLF);

***REMOVED******REMOVED******REMOVED******REMOVED***this.contentLength***REMOVED***=***REMOVED***isStringValue***REMOVED***?***REMOVED***value.byteLength***REMOVED***:***REMOVED***value.size;

***REMOVED******REMOVED******REMOVED******REMOVED***this.size***REMOVED***=***REMOVED***this.headers.byteLength***REMOVED***+***REMOVED***this.contentLength***REMOVED***+***REMOVED***CRLF_BYTES_COUNT;

***REMOVED******REMOVED******REMOVED******REMOVED***this.name***REMOVED***=***REMOVED***name;
***REMOVED******REMOVED******REMOVED******REMOVED***this.value***REMOVED***=***REMOVED***value;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***async***REMOVED****encode(){
***REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***this.headers;

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***{value}***REMOVED***=***REMOVED***this;

***REMOVED******REMOVED******REMOVED******REMOVED***if(utils.isTypedArray(value))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***value;
***REMOVED******REMOVED******REMOVED******REMOVED***}***REMOVED***else***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***yield****REMOVED***readBlob(value);
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***CRLF_BYTES;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***static***REMOVED***escapeName(name)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***String(name).replace(/[\r\n"]/g,***REMOVED***(match)***REMOVED***=>***REMOVED***({
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***'\r'***REMOVED***:***REMOVED***'%0D',
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***'\n'***REMOVED***:***REMOVED***'%0A',
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***'"'***REMOVED***:***REMOVED***'%22',
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}[match]));
***REMOVED******REMOVED***}
}

const***REMOVED***formDataToStream***REMOVED***=***REMOVED***(form,***REMOVED***headersHandler,***REMOVED***options)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED***const***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***tag***REMOVED***=***REMOVED***'form-data-boundary',
***REMOVED******REMOVED******REMOVED******REMOVED***size***REMOVED***=***REMOVED***25,
***REMOVED******REMOVED******REMOVED******REMOVED***boundary***REMOVED***=***REMOVED***tag***REMOVED***+***REMOVED***'-'***REMOVED***+***REMOVED***platform.generateString(size,***REMOVED***BOUNDARY_ALPHABET)
***REMOVED******REMOVED***}***REMOVED***=***REMOVED***options***REMOVED***||***REMOVED***{};

***REMOVED******REMOVED***if(!utils.isFormData(form))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***throw***REMOVED***TypeError('FormData***REMOVED***instance***REMOVED***required');
***REMOVED******REMOVED***}

***REMOVED******REMOVED***if***REMOVED***(boundary.length***REMOVED***<***REMOVED***1***REMOVED***||***REMOVED***boundary.length***REMOVED***>***REMOVED***70)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***throw***REMOVED***Error('boundary***REMOVED***must***REMOVED***be***REMOVED***10-70***REMOVED***characters***REMOVED***long')
***REMOVED******REMOVED***}

***REMOVED******REMOVED***const***REMOVED***boundaryBytes***REMOVED***=***REMOVED***textEncoder.encode('--'***REMOVED***+***REMOVED***boundary***REMOVED***+***REMOVED***CRLF);
***REMOVED******REMOVED***const***REMOVED***footerBytes***REMOVED***=***REMOVED***textEncoder.encode('--'***REMOVED***+***REMOVED***boundary***REMOVED***+***REMOVED***'--'***REMOVED***+***REMOVED***CRLF);
***REMOVED******REMOVED***let***REMOVED***contentLength***REMOVED***=***REMOVED***footerBytes.byteLength;

***REMOVED******REMOVED***const***REMOVED***parts***REMOVED***=***REMOVED***Array.from(form.entries()).map(([name,***REMOVED***value])***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***part***REMOVED***=***REMOVED***new***REMOVED***FormDataPart(name,***REMOVED***value);
***REMOVED******REMOVED******REMOVED******REMOVED***contentLength***REMOVED***+=***REMOVED***part.size;
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***part;
***REMOVED******REMOVED***});

***REMOVED******REMOVED***contentLength***REMOVED***+=***REMOVED***boundaryBytes.byteLength***REMOVED*******REMOVED***parts.length;

***REMOVED******REMOVED***contentLength***REMOVED***=***REMOVED***utils.toFiniteNumber(contentLength);

***REMOVED******REMOVED***const***REMOVED***computedHeaders***REMOVED***=***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***'Content-Type':***REMOVED***`multipart/form-data;***REMOVED***boundary=${boundary}`
***REMOVED******REMOVED***}

***REMOVED******REMOVED***if***REMOVED***(Number.isFinite(contentLength))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***computedHeaders['Content-Length']***REMOVED***=***REMOVED***contentLength;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***headersHandler***REMOVED***&&***REMOVED***headersHandler(computedHeaders);

***REMOVED******REMOVED***return***REMOVED***Readable.from((async***REMOVED***function***REMOVED****()***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***for(const***REMOVED***part***REMOVED***of***REMOVED***parts)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***boundaryBytes;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***yield****REMOVED***part.encode();
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***footerBytes;
***REMOVED******REMOVED***})());
};

export***REMOVED***default***REMOVED***formDataToStream;
