'use***REMOVED***strict';

import***REMOVED***stream***REMOVED***from***REMOVED***'stream';
import***REMOVED***utils***REMOVED***from***REMOVED***'../utils.js';

const***REMOVED***kInternals***REMOVED***=***REMOVED***Symbol('internals');

class***REMOVED***AxiosTransformStream***REMOVED***extends***REMOVED***stream.Transform{
***REMOVED******REMOVED***constructor(options)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***options***REMOVED***=***REMOVED***utils.toFlatObject(options,***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***maxRate:***REMOVED***0,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***chunkSize:***REMOVED***64***REMOVED*******REMOVED***1024,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***minChunkSize:***REMOVED***100,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***timeWindow:***REMOVED***500,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***ticksRate:***REMOVED***2,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***samplesCount:***REMOVED***15
***REMOVED******REMOVED******REMOVED******REMOVED***},***REMOVED***null,***REMOVED***(prop,***REMOVED***source)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***!utils.isUndefined(source[prop]);
***REMOVED******REMOVED******REMOVED******REMOVED***});

***REMOVED******REMOVED******REMOVED******REMOVED***super({
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***readableHighWaterMark:***REMOVED***options.chunkSize
***REMOVED******REMOVED******REMOVED******REMOVED***});

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***internals***REMOVED***=***REMOVED***this[kInternals]***REMOVED***=***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***timeWindow:***REMOVED***options.timeWindow,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***chunkSize:***REMOVED***options.chunkSize,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***maxRate:***REMOVED***options.maxRate,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***minChunkSize:***REMOVED***options.minChunkSize,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***bytesSeen:***REMOVED***0,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***isCaptured:***REMOVED***false,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***notifiedBytesLoaded:***REMOVED***0,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***ts:***REMOVED***Date.now(),
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***bytes:***REMOVED***0,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***onReadCallback:***REMOVED***null
***REMOVED******REMOVED******REMOVED******REMOVED***};

***REMOVED******REMOVED******REMOVED******REMOVED***this.on('newListener',***REMOVED***event***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(event***REMOVED***===***REMOVED***'progress')***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(!internals.isCaptured)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.isCaptured***REMOVED***=***REMOVED***true;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED***});
***REMOVED******REMOVED***}

***REMOVED******REMOVED***_read(size)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***internals***REMOVED***=***REMOVED***this[kInternals];

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(internals.onReadCallback)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.onReadCallback();
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***super._read(size);
***REMOVED******REMOVED***}

***REMOVED******REMOVED***_transform(chunk,***REMOVED***encoding,***REMOVED***callback)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***internals***REMOVED***=***REMOVED***this[kInternals];
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***maxRate***REMOVED***=***REMOVED***internals.maxRate;

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***readableHighWaterMark***REMOVED***=***REMOVED***this.readableHighWaterMark;

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***timeWindow***REMOVED***=***REMOVED***internals.timeWindow;

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***divider***REMOVED***=***REMOVED***1000***REMOVED***/***REMOVED***timeWindow;
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***bytesThreshold***REMOVED***=***REMOVED***(maxRate***REMOVED***/***REMOVED***divider);
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***minChunkSize***REMOVED***=***REMOVED***internals.minChunkSize***REMOVED***!==***REMOVED***false***REMOVED***?***REMOVED***Math.max(internals.minChunkSize,***REMOVED***bytesThreshold***REMOVED*******REMOVED***0.01)***REMOVED***:***REMOVED***0;

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***pushChunk***REMOVED***=***REMOVED***(_chunk,***REMOVED***_callback)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***bytes***REMOVED***=***REMOVED***Buffer.byteLength(_chunk);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.bytesSeen***REMOVED***+=***REMOVED***bytes;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.bytes***REMOVED***+=***REMOVED***bytes;

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.isCaptured***REMOVED***&&***REMOVED***this.emit('progress',***REMOVED***internals.bytesSeen);

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(this.push(_chunk))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***process.nextTick(_callback);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}***REMOVED***else***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.onReadCallback***REMOVED***=***REMOVED***()***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.onReadCallback***REMOVED***=***REMOVED***null;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***process.nextTick(_callback);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***};
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***transformChunk***REMOVED***=***REMOVED***(_chunk,***REMOVED***_callback)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***chunkSize***REMOVED***=***REMOVED***Buffer.byteLength(_chunk);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***chunkRemainder***REMOVED***=***REMOVED***null;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***maxChunkSize***REMOVED***=***REMOVED***readableHighWaterMark;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***bytesLeft;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***passed***REMOVED***=***REMOVED***0;

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(maxRate)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***now***REMOVED***=***REMOVED***Date.now();

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(!internals.ts***REMOVED***||***REMOVED***(passed***REMOVED***=***REMOVED***(now***REMOVED***-***REMOVED***internals.ts))***REMOVED***>=***REMOVED***timeWindow)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.ts***REMOVED***=***REMOVED***now;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***bytesLeft***REMOVED***=***REMOVED***bytesThreshold***REMOVED***-***REMOVED***internals.bytes;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***internals.bytes***REMOVED***=***REMOVED***bytesLeft***REMOVED***<***REMOVED***0***REMOVED***?***REMOVED***-bytesLeft***REMOVED***:***REMOVED***0;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***passed***REMOVED***=***REMOVED***0;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***bytesLeft***REMOVED***=***REMOVED***bytesThreshold***REMOVED***-***REMOVED***internals.bytes;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(maxRate)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(bytesLeft***REMOVED***<=***REMOVED***0)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***next***REMOVED***time***REMOVED***window
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***setTimeout(()***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***_callback(null,***REMOVED***_chunk);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***},***REMOVED***timeWindow***REMOVED***-***REMOVED***passed);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(bytesLeft***REMOVED***<***REMOVED***maxChunkSize)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***maxChunkSize***REMOVED***=***REMOVED***bytesLeft;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(maxChunkSize***REMOVED***&&***REMOVED***chunkSize***REMOVED***>***REMOVED***maxChunkSize***REMOVED***&&***REMOVED***(chunkSize***REMOVED***-***REMOVED***maxChunkSize)***REMOVED***>***REMOVED***minChunkSize)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***chunkRemainder***REMOVED***=***REMOVED***_chunk.subarray(maxChunkSize);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***_chunk***REMOVED***=***REMOVED***_chunk.subarray(0,***REMOVED***maxChunkSize);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***pushChunk(_chunk,***REMOVED***chunkRemainder***REMOVED***?***REMOVED***()***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***process.nextTick(_callback,***REMOVED***null,***REMOVED***chunkRemainder);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}***REMOVED***:***REMOVED***_callback);
***REMOVED******REMOVED******REMOVED******REMOVED***};

***REMOVED******REMOVED******REMOVED******REMOVED***transformChunk(chunk,***REMOVED***function***REMOVED***transformNextChunk(err,***REMOVED***_chunk)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(err)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***callback(err);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(_chunk)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***transformChunk(_chunk,***REMOVED***transformNextChunk);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}***REMOVED***else***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***callback(null);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED***});
***REMOVED******REMOVED***}
}

export***REMOVED***default***REMOVED***AxiosTransformStream;
