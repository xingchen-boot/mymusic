var***REMOVED***Stream***REMOVED***=***REMOVED***require('stream').Stream;
var***REMOVED***util***REMOVED***=***REMOVED***require('util');

module.exports***REMOVED***=***REMOVED***DelayedStream;
function***REMOVED***DelayedStream()***REMOVED***{
***REMOVED******REMOVED***this.source***REMOVED***=***REMOVED***null;
***REMOVED******REMOVED***this.dataSize***REMOVED***=***REMOVED***0;
***REMOVED******REMOVED***this.maxDataSize***REMOVED***=***REMOVED***1024***REMOVED*******REMOVED***1024;
***REMOVED******REMOVED***this.pauseStream***REMOVED***=***REMOVED***true;

***REMOVED******REMOVED***this._maxDataSizeExceeded***REMOVED***=***REMOVED***false;
***REMOVED******REMOVED***this._released***REMOVED***=***REMOVED***false;
***REMOVED******REMOVED***this._bufferedEvents***REMOVED***=***REMOVED***[];
}
util.inherits(DelayedStream,***REMOVED***Stream);

DelayedStream.create***REMOVED***=***REMOVED***function(source,***REMOVED***options)***REMOVED***{
***REMOVED******REMOVED***var***REMOVED***delayedStream***REMOVED***=***REMOVED***new***REMOVED***this();

***REMOVED******REMOVED***options***REMOVED***=***REMOVED***options***REMOVED***||***REMOVED***{};
***REMOVED******REMOVED***for***REMOVED***(var***REMOVED***option***REMOVED***in***REMOVED***options)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***delayedStream[option]***REMOVED***=***REMOVED***options[option];
***REMOVED******REMOVED***}

***REMOVED******REMOVED***delayedStream.source***REMOVED***=***REMOVED***source;

***REMOVED******REMOVED***var***REMOVED***realEmit***REMOVED***=***REMOVED***source.emit;
***REMOVED******REMOVED***source.emit***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***delayedStream._handleEmit(arguments);
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***realEmit.apply(source,***REMOVED***arguments);
***REMOVED******REMOVED***};

***REMOVED******REMOVED***source.on('error',***REMOVED***function()***REMOVED***{});
***REMOVED******REMOVED***if***REMOVED***(delayedStream.pauseStream)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***source.pause();
***REMOVED******REMOVED***}

***REMOVED******REMOVED***return***REMOVED***delayedStream;
};

Object.defineProperty(DelayedStream.prototype,***REMOVED***'readable',***REMOVED***{
***REMOVED******REMOVED***configurable:***REMOVED***true,
***REMOVED******REMOVED***enumerable:***REMOVED***true,
***REMOVED******REMOVED***get:***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***this.source.readable;
***REMOVED******REMOVED***}
});

DelayedStream.prototype.setEncoding***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED***return***REMOVED***this.source.setEncoding.apply(this.source,***REMOVED***arguments);
};

DelayedStream.prototype.resume***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(!this._released)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***this.release();
***REMOVED******REMOVED***}

***REMOVED******REMOVED***this.source.resume();
};

DelayedStream.prototype.pause***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED***this.source.pause();
};

DelayedStream.prototype.release***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED***this._released***REMOVED***=***REMOVED***true;

***REMOVED******REMOVED***this._bufferedEvents.forEach(function(args)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***this.emit.apply(this,***REMOVED***args);
***REMOVED******REMOVED***}.bind(this));
***REMOVED******REMOVED***this._bufferedEvents***REMOVED***=***REMOVED***[];
};

DelayedStream.prototype.pipe***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED***var***REMOVED***r***REMOVED***=***REMOVED***Stream.prototype.pipe.apply(this,***REMOVED***arguments);
***REMOVED******REMOVED***this.resume();
***REMOVED******REMOVED***return***REMOVED***r;
};

DelayedStream.prototype._handleEmit***REMOVED***=***REMOVED***function(args)***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(this._released)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***this.emit.apply(this,***REMOVED***args);
***REMOVED******REMOVED******REMOVED******REMOVED***return;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***if***REMOVED***(args[0]***REMOVED***===***REMOVED***'data')***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***this.dataSize***REMOVED***+=***REMOVED***args[1].length;
***REMOVED******REMOVED******REMOVED******REMOVED***this._checkIfMaxDataSizeExceeded();
***REMOVED******REMOVED***}

***REMOVED******REMOVED***this._bufferedEvents.push(args);
};

DelayedStream.prototype._checkIfMaxDataSizeExceeded***REMOVED***=***REMOVED***function()***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(this._maxDataSizeExceeded)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***if***REMOVED***(this.dataSize***REMOVED***<=***REMOVED***this.maxDataSize)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***this._maxDataSizeExceeded***REMOVED***=***REMOVED***true;
***REMOVED******REMOVED***var***REMOVED***message***REMOVED***=
***REMOVED******REMOVED******REMOVED******REMOVED***'DelayedStream#maxDataSize***REMOVED***of***REMOVED***'***REMOVED***+***REMOVED***this.maxDataSize***REMOVED***+***REMOVED***'***REMOVED***bytes***REMOVED***exceeded.'
***REMOVED******REMOVED***this.emit('error',***REMOVED***new***REMOVED***Error(message));
};
