let***REMOVED***crypto***REMOVED***=***REMOVED***require('crypto')

let***REMOVED***{***REMOVED***urlAlphabet***REMOVED***}***REMOVED***=***REMOVED***require('./url-alphabet/index.cjs')

//***REMOVED***It***REMOVED***is***REMOVED***best***REMOVED***to***REMOVED***make***REMOVED***fewer,***REMOVED***larger***REMOVED***requests***REMOVED***to***REMOVED***the***REMOVED***crypto***REMOVED***module***REMOVED***to
//***REMOVED***avoid***REMOVED***system***REMOVED***call***REMOVED***overhead.***REMOVED***So,***REMOVED***random***REMOVED***numbers***REMOVED***are***REMOVED***generated***REMOVED***in***REMOVED***a
//***REMOVED***pool.***REMOVED***The***REMOVED***pool***REMOVED***is***REMOVED***a***REMOVED***Buffer***REMOVED***that***REMOVED***is***REMOVED***larger***REMOVED***than***REMOVED***the***REMOVED***initial***REMOVED***random
//***REMOVED***request***REMOVED***size***REMOVED***by***REMOVED***this***REMOVED***multiplier.***REMOVED***The***REMOVED***pool***REMOVED***is***REMOVED***enlarged***REMOVED***if***REMOVED***subsequent
//***REMOVED***requests***REMOVED***exceed***REMOVED***the***REMOVED***maximum***REMOVED***buffer***REMOVED***size.
const***REMOVED***POOL_SIZE_MULTIPLIER***REMOVED***=***REMOVED***128
let***REMOVED***pool,***REMOVED***poolOffset

let***REMOVED***fillPool***REMOVED***=***REMOVED***bytes***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(!pool***REMOVED***||***REMOVED***pool.length***REMOVED***<***REMOVED***bytes)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***pool***REMOVED***=***REMOVED***Buffer.allocUnsafe(bytes***REMOVED*******REMOVED***POOL_SIZE_MULTIPLIER)
***REMOVED******REMOVED******REMOVED******REMOVED***crypto.randomFillSync(pool)
***REMOVED******REMOVED******REMOVED******REMOVED***poolOffset***REMOVED***=***REMOVED***0
***REMOVED******REMOVED***}***REMOVED***else***REMOVED***if***REMOVED***(poolOffset***REMOVED***+***REMOVED***bytes***REMOVED***>***REMOVED***pool.length)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***crypto.randomFillSync(pool)
***REMOVED******REMOVED******REMOVED******REMOVED***poolOffset***REMOVED***=***REMOVED***0
***REMOVED******REMOVED***}
***REMOVED******REMOVED***poolOffset***REMOVED***+=***REMOVED***bytes
}

let***REMOVED***random***REMOVED***=***REMOVED***bytes***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED***//***REMOVED***`|=`***REMOVED***convert***REMOVED***`bytes`***REMOVED***to***REMOVED***number***REMOVED***to***REMOVED***prevent***REMOVED***`valueOf`***REMOVED***abusing***REMOVED***and***REMOVED***pool***REMOVED***pollution
***REMOVED******REMOVED***fillPool((bytes***REMOVED***|=***REMOVED***0))
***REMOVED******REMOVED***return***REMOVED***pool.subarray(poolOffset***REMOVED***-***REMOVED***bytes,***REMOVED***poolOffset)
}

let***REMOVED***customRandom***REMOVED***=***REMOVED***(alphabet,***REMOVED***defaultSize,***REMOVED***getRandom)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED***//***REMOVED***First,***REMOVED***a***REMOVED***bitmask***REMOVED***is***REMOVED***necessary***REMOVED***to***REMOVED***generate***REMOVED***the***REMOVED***ID.***REMOVED***The***REMOVED***bitmask***REMOVED***makes***REMOVED***bytes
***REMOVED******REMOVED***//***REMOVED***values***REMOVED***closer***REMOVED***to***REMOVED***the***REMOVED***alphabet***REMOVED***size.***REMOVED***The***REMOVED***bitmask***REMOVED***calculates***REMOVED***the***REMOVED***closest
***REMOVED******REMOVED***//***REMOVED***`2^31***REMOVED***-***REMOVED***1`***REMOVED***number,***REMOVED***which***REMOVED***exceeds***REMOVED***the***REMOVED***alphabet***REMOVED***size.
***REMOVED******REMOVED***//***REMOVED***For***REMOVED***example,***REMOVED***the***REMOVED***bitmask***REMOVED***for***REMOVED***the***REMOVED***alphabet***REMOVED***size***REMOVED***30***REMOVED***is***REMOVED***31***REMOVED***(00011111).
***REMOVED******REMOVED***let***REMOVED***mask***REMOVED***=***REMOVED***(2***REMOVED***<<***REMOVED***(31***REMOVED***-***REMOVED***Math.clz32((alphabet.length***REMOVED***-***REMOVED***1)***REMOVED***|***REMOVED***1)))***REMOVED***-***REMOVED***1
***REMOVED******REMOVED***//***REMOVED***Though,***REMOVED***the***REMOVED***bitmask***REMOVED***solution***REMOVED***is***REMOVED***not***REMOVED***perfect***REMOVED***since***REMOVED***the***REMOVED***bytes***REMOVED***exceeding
***REMOVED******REMOVED***//***REMOVED***the***REMOVED***alphabet***REMOVED***size***REMOVED***are***REMOVED***refused.***REMOVED***Therefore,***REMOVED***to***REMOVED***reliably***REMOVED***generate***REMOVED***the***REMOVED***ID,
***REMOVED******REMOVED***//***REMOVED***the***REMOVED***random***REMOVED***bytes***REMOVED***redundancy***REMOVED***has***REMOVED***to***REMOVED***be***REMOVED***satisfied.

***REMOVED******REMOVED***//***REMOVED***Note:***REMOVED***every***REMOVED***hardware***REMOVED***random***REMOVED***generator***REMOVED***call***REMOVED***is***REMOVED***performance***REMOVED***expensive,
***REMOVED******REMOVED***//***REMOVED***because***REMOVED***the***REMOVED***system***REMOVED***call***REMOVED***for***REMOVED***entropy***REMOVED***collection***REMOVED***takes***REMOVED***a***REMOVED***lot***REMOVED***of***REMOVED***time.
***REMOVED******REMOVED***//***REMOVED***So,***REMOVED***to***REMOVED***avoid***REMOVED***additional***REMOVED***system***REMOVED***calls,***REMOVED***extra***REMOVED***bytes***REMOVED***are***REMOVED***requested***REMOVED***in***REMOVED***advance.

***REMOVED******REMOVED***//***REMOVED***Next,***REMOVED***a***REMOVED***step***REMOVED***determines***REMOVED***how***REMOVED***many***REMOVED***random***REMOVED***bytes***REMOVED***to***REMOVED***generate.
***REMOVED******REMOVED***//***REMOVED***The***REMOVED***number***REMOVED***of***REMOVED***random***REMOVED***bytes***REMOVED***gets***REMOVED***decided***REMOVED***upon***REMOVED***the***REMOVED***ID***REMOVED***size,***REMOVED***mask,
***REMOVED******REMOVED***//***REMOVED***alphabet***REMOVED***size,***REMOVED***and***REMOVED***magic***REMOVED***number***REMOVED***1.6***REMOVED***(using***REMOVED***1.6***REMOVED***peaks***REMOVED***at***REMOVED***performance
***REMOVED******REMOVED***//***REMOVED***according***REMOVED***to***REMOVED***benchmarks).
***REMOVED******REMOVED***let***REMOVED***step***REMOVED***=***REMOVED***Math.ceil((1.6***REMOVED*******REMOVED***mask***REMOVED*******REMOVED***defaultSize)***REMOVED***/***REMOVED***alphabet.length)

***REMOVED******REMOVED***return***REMOVED***(size***REMOVED***=***REMOVED***defaultSize)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***id***REMOVED***=***REMOVED***''
***REMOVED******REMOVED******REMOVED******REMOVED***while***REMOVED***(true)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***bytes***REMOVED***=***REMOVED***getRandom(step)
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***A***REMOVED***compact***REMOVED***alternative***REMOVED***for***REMOVED***`for***REMOVED***(let***REMOVED***i***REMOVED***=***REMOVED***0;***REMOVED***i***REMOVED***<***REMOVED***step;***REMOVED***i++)`.
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***i***REMOVED***=***REMOVED***step
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***while***REMOVED***(i--)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***Adding***REMOVED***`||***REMOVED***''`***REMOVED***refuses***REMOVED***a***REMOVED***random***REMOVED***byte***REMOVED***that***REMOVED***exceeds***REMOVED***the***REMOVED***alphabet***REMOVED***size.
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***id***REMOVED***+=***REMOVED***alphabet[bytes[i]***REMOVED***&***REMOVED***mask]***REMOVED***||***REMOVED***''
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(id.length***REMOVED***===***REMOVED***size)***REMOVED***return***REMOVED***id
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED***}
}

let***REMOVED***customAlphabet***REMOVED***=***REMOVED***(alphabet,***REMOVED***size***REMOVED***=***REMOVED***21)***REMOVED***=>
***REMOVED******REMOVED***customRandom(alphabet,***REMOVED***size,***REMOVED***random)

let***REMOVED***nanoid***REMOVED***=***REMOVED***(size***REMOVED***=***REMOVED***21)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED***//***REMOVED***`|=`***REMOVED***convert***REMOVED***`size`***REMOVED***to***REMOVED***number***REMOVED***to***REMOVED***prevent***REMOVED***`valueOf`***REMOVED***abusing***REMOVED***and***REMOVED***pool***REMOVED***pollution
***REMOVED******REMOVED***fillPool((size***REMOVED***|=***REMOVED***0))
***REMOVED******REMOVED***let***REMOVED***id***REMOVED***=***REMOVED***''
***REMOVED******REMOVED***//***REMOVED***We***REMOVED***are***REMOVED***reading***REMOVED***directly***REMOVED***from***REMOVED***the***REMOVED***random***REMOVED***pool***REMOVED***to***REMOVED***avoid***REMOVED***creating***REMOVED***new***REMOVED***array
***REMOVED******REMOVED***for***REMOVED***(let***REMOVED***i***REMOVED***=***REMOVED***poolOffset***REMOVED***-***REMOVED***size;***REMOVED***i***REMOVED***<***REMOVED***poolOffset;***REMOVED***i++)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***It***REMOVED***is***REMOVED***incorrect***REMOVED***to***REMOVED***use***REMOVED***bytes***REMOVED***exceeding***REMOVED***the***REMOVED***alphabet***REMOVED***size.
***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***The***REMOVED***following***REMOVED***mask***REMOVED***reduces***REMOVED***the***REMOVED***random***REMOVED***byte***REMOVED***in***REMOVED***the***REMOVED***0-255***REMOVED***value
***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***range***REMOVED***to***REMOVED***the***REMOVED***0-63***REMOVED***value***REMOVED***range.***REMOVED***Therefore,***REMOVED***adding***REMOVED***hacks,***REMOVED***such
***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***as***REMOVED***empty***REMOVED***string***REMOVED***fallback***REMOVED***or***REMOVED***magic***REMOVED***numbers,***REMOVED***is***REMOVED***unneccessary***REMOVED***because
***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***the***REMOVED***bitmask***REMOVED***trims***REMOVED***bytes***REMOVED***down***REMOVED***to***REMOVED***the***REMOVED***alphabet***REMOVED***size.
***REMOVED******REMOVED******REMOVED******REMOVED***id***REMOVED***+=***REMOVED***urlAlphabet[pool[i]***REMOVED***&***REMOVED***63]
***REMOVED******REMOVED***}
***REMOVED******REMOVED***return***REMOVED***id
}

module.exports***REMOVED***=***REMOVED***{***REMOVED***nanoid,***REMOVED***customAlphabet,***REMOVED***customRandom,***REMOVED***urlAlphabet,***REMOVED***random***REMOVED***}
