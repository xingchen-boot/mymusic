
export***REMOVED***const***REMOVED***streamChunk***REMOVED***=***REMOVED***function****REMOVED***(chunk,***REMOVED***chunkSize)***REMOVED***{
***REMOVED******REMOVED***let***REMOVED***len***REMOVED***=***REMOVED***chunk.byteLength;

***REMOVED******REMOVED***if***REMOVED***(!chunkSize***REMOVED***||***REMOVED***len***REMOVED***<***REMOVED***chunkSize)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***chunk;
***REMOVED******REMOVED******REMOVED******REMOVED***return;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***let***REMOVED***pos***REMOVED***=***REMOVED***0;
***REMOVED******REMOVED***let***REMOVED***end;

***REMOVED******REMOVED***while***REMOVED***(pos***REMOVED***<***REMOVED***len)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***end***REMOVED***=***REMOVED***pos***REMOVED***+***REMOVED***chunkSize;
***REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***chunk.slice(pos,***REMOVED***end);
***REMOVED******REMOVED******REMOVED******REMOVED***pos***REMOVED***=***REMOVED***end;
***REMOVED******REMOVED***}
}

export***REMOVED***const***REMOVED***readBytes***REMOVED***=***REMOVED***async***REMOVED***function****REMOVED***(iterable,***REMOVED***chunkSize)***REMOVED***{
***REMOVED******REMOVED***for***REMOVED***await***REMOVED***(const***REMOVED***chunk***REMOVED***of***REMOVED***readStream(iterable))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***yield****REMOVED***streamChunk(chunk,***REMOVED***chunkSize);
***REMOVED******REMOVED***}
}

const***REMOVED***readStream***REMOVED***=***REMOVED***async***REMOVED***function****REMOVED***(stream)***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(stream[Symbol.asyncIterator])***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***yield****REMOVED***stream;
***REMOVED******REMOVED******REMOVED******REMOVED***return;
***REMOVED******REMOVED***}

***REMOVED******REMOVED***const***REMOVED***reader***REMOVED***=***REMOVED***stream.getReader();
***REMOVED******REMOVED***try***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***for***REMOVED***(;;)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***{done,***REMOVED***value}***REMOVED***=***REMOVED***await***REMOVED***reader.read();
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(done)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***break;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***yield***REMOVED***value;
***REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED***}***REMOVED***finally***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***await***REMOVED***reader.cancel();
***REMOVED******REMOVED***}
}

export***REMOVED***const***REMOVED***trackStream***REMOVED***=***REMOVED***(stream,***REMOVED***chunkSize,***REMOVED***onProgress,***REMOVED***onFinish)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED***const***REMOVED***iterator***REMOVED***=***REMOVED***readBytes(stream,***REMOVED***chunkSize);

***REMOVED******REMOVED***let***REMOVED***bytes***REMOVED***=***REMOVED***0;
***REMOVED******REMOVED***let***REMOVED***done;
***REMOVED******REMOVED***let***REMOVED***_onFinish***REMOVED***=***REMOVED***(e)***REMOVED***=>***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(!done)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***done***REMOVED***=***REMOVED***true;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***onFinish***REMOVED***&&***REMOVED***onFinish(e);
***REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED***}

***REMOVED******REMOVED***return***REMOVED***new***REMOVED***ReadableStream({
***REMOVED******REMOVED******REMOVED******REMOVED***async***REMOVED***pull(controller)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***try***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***{done,***REMOVED***value}***REMOVED***=***REMOVED***await***REMOVED***iterator.next();

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(done)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***_onFinish();
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***controller.close();
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***len***REMOVED***=***REMOVED***value.byteLength;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(onProgress)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***loadedBytes***REMOVED***=***REMOVED***bytes***REMOVED***+=***REMOVED***len;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***onProgress(loadedBytes);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***controller.enqueue(new***REMOVED***Uint8Array(value));
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}***REMOVED***catch***REMOVED***(err)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***_onFinish(err);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***throw***REMOVED***err;
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED***},
***REMOVED******REMOVED******REMOVED******REMOVED***cancel(reason)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***_onFinish(reason);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***iterator.return();
***REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED***},***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***highWaterMark:***REMOVED***2
***REMOVED******REMOVED***})
}
