/*!
***REMOVED*******REMOVED***mime-types
***REMOVED*******REMOVED***Copyright(c)***REMOVED***2014***REMOVED***Jonathan***REMOVED***Ong
***REMOVED*******REMOVED***Copyright(c)***REMOVED***2015***REMOVED***Douglas***REMOVED***Christopher***REMOVED***Wilson
***REMOVED*******REMOVED***MIT***REMOVED***Licensed
***REMOVED****/

'use***REMOVED***strict'

/**
***REMOVED*******REMOVED***Module***REMOVED***dependencies.
***REMOVED*******REMOVED***@private
***REMOVED****/

var***REMOVED***db***REMOVED***=***REMOVED***require('mime-db')
var***REMOVED***extname***REMOVED***=***REMOVED***require('path').extname

/**
***REMOVED*******REMOVED***Module***REMOVED***variables.
***REMOVED*******REMOVED***@private
***REMOVED****/

var***REMOVED***EXTRACT_TYPE_REGEXP***REMOVED***=***REMOVED***/^\s*([^;\s]*)(?:;|\s|$)/
var***REMOVED***TEXT_TYPE_REGEXP***REMOVED***=***REMOVED***/^text\//i

/**
***REMOVED*******REMOVED***Module***REMOVED***exports.
***REMOVED*******REMOVED***@public
***REMOVED****/

exports.charset***REMOVED***=***REMOVED***charset
exports.charsets***REMOVED***=***REMOVED***{***REMOVED***lookup:***REMOVED***charset***REMOVED***}
exports.contentType***REMOVED***=***REMOVED***contentType
exports.extension***REMOVED***=***REMOVED***extension
exports.extensions***REMOVED***=***REMOVED***Object.create(null)
exports.lookup***REMOVED***=***REMOVED***lookup
exports.types***REMOVED***=***REMOVED***Object.create(null)

//***REMOVED***Populate***REMOVED***the***REMOVED***extensions/types***REMOVED***maps
populateMaps(exports.extensions,***REMOVED***exports.types)

/**
***REMOVED*******REMOVED***Get***REMOVED***the***REMOVED***default***REMOVED***charset***REMOVED***for***REMOVED***a***REMOVED***MIME***REMOVED***type.
***REMOVED****
***REMOVED*******REMOVED***@param***REMOVED***{string}***REMOVED***type
***REMOVED*******REMOVED***@return***REMOVED***{boolean|string}
***REMOVED****/

function***REMOVED***charset***REMOVED***(type)***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(!type***REMOVED***||***REMOVED***typeof***REMOVED***type***REMOVED***!==***REMOVED***'string')***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***//***REMOVED***TODO:***REMOVED***use***REMOVED***media-typer
***REMOVED******REMOVED***var***REMOVED***match***REMOVED***=***REMOVED***EXTRACT_TYPE_REGEXP.exec(type)
***REMOVED******REMOVED***var***REMOVED***mime***REMOVED***=***REMOVED***match***REMOVED***&&***REMOVED***db[match[1].toLowerCase()]

***REMOVED******REMOVED***if***REMOVED***(mime***REMOVED***&&***REMOVED***mime.charset)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***mime.charset
***REMOVED******REMOVED***}

***REMOVED******REMOVED***//***REMOVED***default***REMOVED***text/****REMOVED***to***REMOVED***utf-8
***REMOVED******REMOVED***if***REMOVED***(match***REMOVED***&&***REMOVED***TEXT_TYPE_REGEXP.test(match[1]))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***'UTF-8'
***REMOVED******REMOVED***}

***REMOVED******REMOVED***return***REMOVED***false
}

/**
***REMOVED*******REMOVED***Create***REMOVED***a***REMOVED***full***REMOVED***Content-Type***REMOVED***header***REMOVED***given***REMOVED***a***REMOVED***MIME***REMOVED***type***REMOVED***or***REMOVED***extension.
***REMOVED****
***REMOVED*******REMOVED***@param***REMOVED***{string}***REMOVED***str
***REMOVED*******REMOVED***@return***REMOVED***{boolean|string}
***REMOVED****/

function***REMOVED***contentType***REMOVED***(str)***REMOVED***{
***REMOVED******REMOVED***//***REMOVED***TODO:***REMOVED***should***REMOVED***this***REMOVED***even***REMOVED***be***REMOVED***in***REMOVED***this***REMOVED***module?
***REMOVED******REMOVED***if***REMOVED***(!str***REMOVED***||***REMOVED***typeof***REMOVED***str***REMOVED***!==***REMOVED***'string')***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***var***REMOVED***mime***REMOVED***=***REMOVED***str.indexOf('/')***REMOVED***===***REMOVED***-1
***REMOVED******REMOVED******REMOVED******REMOVED***?***REMOVED***exports.lookup(str)
***REMOVED******REMOVED******REMOVED******REMOVED***:***REMOVED***str

***REMOVED******REMOVED***if***REMOVED***(!mime)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***//***REMOVED***TODO:***REMOVED***use***REMOVED***content-type***REMOVED***or***REMOVED***other***REMOVED***module
***REMOVED******REMOVED***if***REMOVED***(mime.indexOf('charset')***REMOVED***===***REMOVED***-1)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***var***REMOVED***charset***REMOVED***=***REMOVED***exports.charset(mime)
***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(charset)***REMOVED***mime***REMOVED***+=***REMOVED***';***REMOVED***charset='***REMOVED***+***REMOVED***charset.toLowerCase()
***REMOVED******REMOVED***}

***REMOVED******REMOVED***return***REMOVED***mime
}

/**
***REMOVED*******REMOVED***Get***REMOVED***the***REMOVED***default***REMOVED***extension***REMOVED***for***REMOVED***a***REMOVED***MIME***REMOVED***type.
***REMOVED****
***REMOVED*******REMOVED***@param***REMOVED***{string}***REMOVED***type
***REMOVED*******REMOVED***@return***REMOVED***{boolean|string}
***REMOVED****/

function***REMOVED***extension***REMOVED***(type)***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(!type***REMOVED***||***REMOVED***typeof***REMOVED***type***REMOVED***!==***REMOVED***'string')***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***//***REMOVED***TODO:***REMOVED***use***REMOVED***media-typer
***REMOVED******REMOVED***var***REMOVED***match***REMOVED***=***REMOVED***EXTRACT_TYPE_REGEXP.exec(type)

***REMOVED******REMOVED***//***REMOVED***get***REMOVED***extensions
***REMOVED******REMOVED***var***REMOVED***exts***REMOVED***=***REMOVED***match***REMOVED***&&***REMOVED***exports.extensions[match[1].toLowerCase()]

***REMOVED******REMOVED***if***REMOVED***(!exts***REMOVED***||***REMOVED***!exts.length)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***return***REMOVED***exts[0]
}

/**
***REMOVED*******REMOVED***Lookup***REMOVED***the***REMOVED***MIME***REMOVED***type***REMOVED***for***REMOVED***a***REMOVED***file***REMOVED***path/extension.
***REMOVED****
***REMOVED*******REMOVED***@param***REMOVED***{string}***REMOVED***path
***REMOVED*******REMOVED***@return***REMOVED***{boolean|string}
***REMOVED****/

function***REMOVED***lookup***REMOVED***(path)***REMOVED***{
***REMOVED******REMOVED***if***REMOVED***(!path***REMOVED***||***REMOVED***typeof***REMOVED***path***REMOVED***!==***REMOVED***'string')***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***//***REMOVED***get***REMOVED***the***REMOVED***extension***REMOVED***("ext"***REMOVED***or***REMOVED***".ext"***REMOVED***or***REMOVED***full***REMOVED***path)
***REMOVED******REMOVED***var***REMOVED***extension***REMOVED***=***REMOVED***extname('x.'***REMOVED***+***REMOVED***path)
***REMOVED******REMOVED******REMOVED******REMOVED***.toLowerCase()
***REMOVED******REMOVED******REMOVED******REMOVED***.substr(1)

***REMOVED******REMOVED***if***REMOVED***(!extension)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***false
***REMOVED******REMOVED***}

***REMOVED******REMOVED***return***REMOVED***exports.types[extension]***REMOVED***||***REMOVED***false
}

/**
***REMOVED*******REMOVED***Populate***REMOVED***the***REMOVED***extensions***REMOVED***and***REMOVED***types***REMOVED***maps.
***REMOVED*******REMOVED***@private
***REMOVED****/

function***REMOVED***populateMaps***REMOVED***(extensions,***REMOVED***types)***REMOVED***{
***REMOVED******REMOVED***//***REMOVED***source***REMOVED***preference***REMOVED***(least***REMOVED***->***REMOVED***most)
***REMOVED******REMOVED***var***REMOVED***preference***REMOVED***=***REMOVED***['nginx',***REMOVED***'apache',***REMOVED***undefined,***REMOVED***'iana']

***REMOVED******REMOVED***Object.keys(db).forEach(function***REMOVED***forEachMimeType***REMOVED***(type)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***var***REMOVED***mime***REMOVED***=***REMOVED***db[type]
***REMOVED******REMOVED******REMOVED******REMOVED***var***REMOVED***exts***REMOVED***=***REMOVED***mime.extensions

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(!exts***REMOVED***||***REMOVED***!exts.length)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***return
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***mime***REMOVED***->***REMOVED***extensions
***REMOVED******REMOVED******REMOVED******REMOVED***extensions[type]***REMOVED***=***REMOVED***exts

***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***extension***REMOVED***->***REMOVED***mime
***REMOVED******REMOVED******REMOVED******REMOVED***for***REMOVED***(var***REMOVED***i***REMOVED***=***REMOVED***0;***REMOVED***i***REMOVED***<***REMOVED***exts.length;***REMOVED***i++)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***var***REMOVED***extension***REMOVED***=***REMOVED***exts[i]

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(types[extension])***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***var***REMOVED***from***REMOVED***=***REMOVED***preference.indexOf(db[types[extension]].source)
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***var***REMOVED***to***REMOVED***=***REMOVED***preference.indexOf(mime.source)

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(types[extension]***REMOVED***!==***REMOVED***'application/octet-stream'***REMOVED***&&
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***(from***REMOVED***>***REMOVED***to***REMOVED***||***REMOVED***(from***REMOVED***===***REMOVED***to***REMOVED***&&***REMOVED***types[extension].substr(0,***REMOVED***12)***REMOVED***===***REMOVED***'application/')))***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***skip***REMOVED***the***REMOVED***remapping
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***continue
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***set***REMOVED***the***REMOVED***extension***REMOVED***->***REMOVED***mime
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***types[extension]***REMOVED***=***REMOVED***type
***REMOVED******REMOVED******REMOVED******REMOVED***}
***REMOVED******REMOVED***})
}
