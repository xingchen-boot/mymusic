#***REMOVED***本次功能更新说明（个人中心与头像上传、最近播放优化***REMOVED***等）

##***REMOVED***1.***REMOVED***背景目标
-***REMOVED***新增“个人中心（Profile）”：支持悬停头像进入个人中心，独立修改昵称或头像。
-***REMOVED***头像上传通过后端代理上传到阿里云***REMOVED***OSS，仅保存***REMOVED***URL，避免数据库超长问题与前端直传的***REMOVED***CORS***REMOVED***问题。
-***REMOVED***修复头像压缩导致比例变形问题（保持原始宽高比，最长边***REMOVED***200px）。
-***REMOVED***最近播放页面体验优化：使用事件总线增量更新，避免整页刷新导致的闪烁与多次加载。
-***REMOVED***播放模式简化：采用“临时替换播放队列”的方式实现“播放我喜欢的”。

##***REMOVED***2.***REMOVED***变更清单（概览）
-***REMOVED***前端（Vue***REMOVED***3***REMOVED***+***REMOVED***TS***REMOVED***+***REMOVED***Element***REMOVED***Plus）
***REMOVED******REMOVED***-***REMOVED***`components/Header.vue`：头像悬停菜单，进入***REMOVED***`/profile`。
***REMOVED******REMOVED***-***REMOVED***`views/Profile.vue`：
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***头像与昵称可独立保存（不再需要两者都变更才能保存）。
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***头像选择后本地预览；限制***REMOVED***≤***REMOVED***2MB；压缩保持比例，最长边***REMOVED***200px。
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***保存时：若头像变更→调用后端***REMOVED***`/api/oss/upload`***REMOVED***获得***REMOVED***URL，再***REMOVED***`PUT***REMOVED***/api/user/info/{id}`。
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***本地与全局同步：成功后更新***REMOVED***`userStore.currentUser`***REMOVED***并写入***REMOVED***`localStorage('userInfo')`，Header***REMOVED***联动更新。
***REMOVED******REMOVED***-***REMOVED***`stores/music.ts`：
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***最近播放事件总线（record/progress）→***REMOVED***`Recent.vue`***REMOVED***增量更新。
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***播放队列重构：用临时替换策略实现“播放我喜欢的”，切回时恢复原队列。
***REMOVED******REMOVED***-***REMOVED***`views/Recent.vue`：
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***订阅事件总线，实时增量更新（顶部插入/上移当前项）。
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***操作按钮风格与***REMOVED***`Search.vue`***REMOVED***对齐，纯图标***REMOVED***+***REMOVED***悬浮提示。
***REMOVED******REMOVED***-***REMOVED***`frontend/README.md`：补充个人中心与***REMOVED***OSS***REMOVED***配置、API***REMOVED***端点、实现细节与日志。

-***REMOVED***后端（Spring***REMOVED***Boot***REMOVED***+***REMOVED***MyBatis***REMOVED***+***REMOVED***MySQL）
***REMOVED******REMOVED***-***REMOVED***`controller/OssController.java`：
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***`POST***REMOVED***/api/oss/upload`：后端代理上传头像到***REMOVED***OSS，返回公开***REMOVED***URL。
***REMOVED******REMOVED******REMOVED******REMOVED***-***REMOVED***`GET***REMOVED***/api/oss/policy`：如需直传，提供临时策略（含参数校验与报错信息）。
***REMOVED******REMOVED***-***REMOVED***`controller/UserController.java`：`PUT***REMOVED***/api/user/info/{id}`***REMOVED***支持部分字段更新（昵称/头像任意可选）。
***REMOVED******REMOVED***-***REMOVED***`mapper/UserMapper.java`：`UPDATE`***REMOVED***使用***REMOVED***`COALESCE(?,***REMOVED***column)`***REMOVED***保持未传字段原值。
***REMOVED******REMOVED***-***REMOVED***`application.yml`：新增***REMOVED***`oss.bucket/region/endpoint`***REMOVED***配置；建议用环境变量提供***REMOVED***`OSS_ACCESS_KEY_ID/SECRET`。

-***REMOVED***版本库与安全
***REMOVED******REMOVED***-***REMOVED***根目录新增***REMOVED***`.gitignore`，忽略***REMOVED***`阿里云key.md`。
***REMOVED******REMOVED***-***REMOVED***已将***REMOVED***`阿里云key.md`***REMOVED***从***REMOVED***Git***REMOVED***索引移除但保留本地文件。

##***REMOVED***3.***REMOVED***详细实现
###***REMOVED***3.1***REMOVED***个人中心（Profile）
-***REMOVED***入口：Header***REMOVED***头像悬停菜单***REMOVED***→***REMOVED***“个人中心”。
-***REMOVED***表单：
***REMOVED******REMOVED***-***REMOVED***头像：上传***REMOVED***→***REMOVED***本地预览（Object***REMOVED***URL）→***REMOVED***压缩（canvas***REMOVED***保持比例，最长边***REMOVED***200px）→***REMOVED***若变更则先***REMOVED***`/api/oss/upload`***REMOVED***→***REMOVED***得到***REMOVED***URL。
***REMOVED******REMOVED***-***REMOVED***昵称：可独立修改。
***REMOVED******REMOVED***-***REMOVED***保存：仅提交发生变化的字段；未变化字段不提交（后端用***REMOVED***`COALESCE`***REMOVED***保持原值）。
-***REMOVED***体验：
***REMOVED******REMOVED***-***REMOVED***未设置头像时显示随机头像***REMOVED***`https://picsum.photos/...`。
***REMOVED******REMOVED***-***REMOVED***成功后更新***REMOVED***Pinia***REMOVED***`userStore.currentUser`***REMOVED***与***REMOVED***`localStorage('userInfo')`，Header***REMOVED***实时生效。

###***REMOVED***3.2***REMOVED***头像比例修复
-***REMOVED***旧逻辑：固定绘制为***REMOVED***200x200，导致拉伸变形。
-***REMOVED***新逻辑：
***REMOVED******REMOVED***-***REMOVED***计算原始宽高，按比例缩放至最长边***REMOVED***200px；小图不放大。
***REMOVED******REMOVED***-***REMOVED***CSS***REMOVED***使用***REMOVED***`object-fit:***REMOVED***cover`***REMOVED***配合圆形裁剪，避免视觉拉伸。

###***REMOVED***3.3***REMOVED***最近播放体验优化
-***REMOVED***播放/进度更新时通过***REMOVED***Pinia***REMOVED***内自建事件总线通知订阅者。
-***REMOVED***`Recent.vue`***REMOVED***订阅后做“增量更新”：
***REMOVED******REMOVED***-***REMOVED***播放时：若已有记录→上移至顶部并更新时间；否则插入一条到顶部。
***REMOVED******REMOVED***-***REMOVED***进度时：仅更新该项字段，保留列表，不整页刷新。

###***REMOVED***3.4***REMOVED***播放我喜欢的（临时替换队列）
-***REMOVED***切换“播放我喜欢的”时：
***REMOVED******REMOVED***-***REMOVED***记录原始播放队列于内存（不写数据库）。
***REMOVED******REMOVED***-***REMOVED***清空队列并填入收藏列表（不写数据库）。
-***REMOVED***切回时：
***REMOVED******REMOVED***-***REMOVED***恢复内存中的原始队列，并重新同步到数据库。
-***REMOVED***优点：逻辑简单、状态清晰、贴近主流播放器的行为。

##***REMOVED***4.***REMOVED***API***REMOVED***与配置摘要
-***REMOVED***前端主要端点：
***REMOVED******REMOVED***-***REMOVED***`PUT***REMOVED***/api/user/info/{id}`：更新用户信息（头像/昵称任意字段）。
***REMOVED******REMOVED***-***REMOVED***`POST***REMOVED***/api/oss/upload`：上传头像文件，返回***REMOVED***URL。
***REMOVED******REMOVED***-***REMOVED***`GET***REMOVED***/api/oss/policy`：如需直传时使用的临时策略。
-***REMOVED***OSS***REMOVED***配置（`springboot/src/main/resources/application.yml`）：
***REMOVED******REMOVED***-***REMOVED***`oss.bucket`:***REMOVED***例***REMOVED***`my-music-avatar`
***REMOVED******REMOVED***-***REMOVED***`oss.region`:***REMOVED***例***REMOVED***`oss-cn-beijing`
***REMOVED******REMOVED***-***REMOVED***`oss.endpoint`:***REMOVED***例***REMOVED***`https://oss-cn-beijing.aliyuncs.com`
***REMOVED******REMOVED***-***REMOVED***环境变量：`OSS_ACCESS_KEY_ID`、`OSS_ACCESS_KEY_SECRET`
***REMOVED******REMOVED***-***REMOVED***桶策略：公共读***REMOVED***+***REMOVED***CORS***REMOVED***允许***REMOVED***GET/POST/PUT（允许头*，暴露***REMOVED***ETag）

##***REMOVED***5.***REMOVED***使用说明（头像上传）
1.***REMOVED***在系统中选择新头像（≤***REMOVED***2MB）。
2.***REMOVED***页面即时预览（本地，不上传）。
3.***REMOVED***点击保存：若头像变更则后端代理上传到***REMOVED***OSS，返回***REMOVED***URL；前端再调用***REMOVED***`PUT***REMOVED***/api/user/info/{id}`***REMOVED***保存***REMOVED***URL***REMOVED***与昵称。
4.***REMOVED***成功提示后，Header***REMOVED***昵称与头像即时更新。

##***REMOVED***6.***REMOVED***已修复问题
-***REMOVED***Data***REMOVED***Truncation（avatar***REMOVED***字段过短）：改为保存***REMOVED***URL，且建议将***REMOVED***`user.avatar`***REMOVED***字段类型为***REMOVED***`TEXT`***REMOVED***或足够长的***REMOVED***`VARCHAR`。
-***REMOVED***直传***REMOVED***OSS***REMOVED***CORS***REMOVED***问题：改为后端代理上传。
-***REMOVED***上传策略***REMOVED***500/undefined：增加后端与前端参数校验，失败即中断。
-***REMOVED***头像比例问题：压缩保持比例***REMOVED***+***REMOVED***`object-fit:***REMOVED***cover`。
-***REMOVED***收藏/最近播放实时性与抖动：事件总线***REMOVED***+***REMOVED***增量更新。

##***REMOVED***7.***REMOVED***验收清单
-***REMOVED***[***REMOVED***]***REMOVED***未登录时，Header***REMOVED***显示登录按钮；登录后显示头像与昵称。
-***REMOVED***[***REMOVED***]***REMOVED***个人中心可单独修改昵称并保存。
-***REMOVED***[***REMOVED***]***REMOVED***个人中心可单独修改头像并保存，Header***REMOVED***立即更新。
-***REMOVED***[***REMOVED***]***REMOVED***大尺寸图片上传后显示不变形；小图不被放大。
-***REMOVED***[***REMOVED***]***REMOVED***切换“播放我喜欢的”后，队列替换为收藏列表；切回成功恢复。
-***REMOVED***[***REMOVED***]***REMOVED***最近播放在播放/进度变化后无整页刷新、不卡顿。

##***REMOVED***8.***REMOVED***回退策略
-***REMOVED***个人中心与头像上传：如需回退，可移除***REMOVED***`/api/oss/upload`***REMOVED***调用，改回仅昵称可改；或暂时禁用头像修改入口。
-***REMOVED***最近播放增量更新：可临时改回“整页刷新”的拉取方式（不推荐）。

---
如需对个人中心页面继续增强（例如接入裁剪组件***REMOVED***cropper.js，实现手动裁剪后上传），可以在本文件追加计划与实现步骤。
